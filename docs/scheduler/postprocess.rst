.. _postprocess:

Post-process Schedules
======================

This module post-processes observation scheduling plans generated by the :math:`\mathrm{M^4OPT}` framework.
It computes the detection probability at known position and extracts optimization
metrics such as objective value, best bound, solution time, and number of observed fields, as well as the initial params
from skymap file. It supports both command-line arguments and `.ini` configuration files.

Overview
--------

The script performs the following steps:

1. **Read observation metadata** from a summary ECSV file.
2. **Loop through each schedule file** to compute:
   - Detection probability (known position),
   - Optimization metrics such as objective value and solution time.
3. **Write the result** into a merged output file (`events.ecsv`), which can be reused for further statistical or scientific analysis.

Usage
-----

From the command line:

.. code-block:: bash

    python postprocess_schedules.py --data-dir data

Or using a configuration file:

.. code-block:: bash

    python postprocess_schedules.py --config params_ultrasat.ini

The `.ini` config file must contain a `[params]` section with fields like:

.. code-block:: ini

    [params]
    data_dir = data
    event_table = observing-scenarios.ecsv
    output_file = events.ecsv
    sched_dir = schedules

Essential Output Parameters
---------------------------

Below is a summary of the output fields stored in the final ``events.ecsv`` file:

.. grid:: 2
    :gutter: 2

    .. grid-item-card:: detection_probability_known_position
        :margin: 1
        :shadow: md
        :icon: octicon-graph

        Estimated detection probability for the event using known source position.
        Computed via `get_detection_probability_known_position`.

    .. grid-item-card:: objective_value
        :margin: 1
        :shadow: md
        :icon: octicon-rocket

        Final objective value from the optimization process (e.g., maximizing probability or coverage).

    .. grid-item-card:: best_bound
        :margin: 1
        :shadow: md
        :icon: octicon-pin

        The best known bound (e.g., from the solver) during the scheduling process.

    .. grid-item-card:: solution_status
        :margin: 1
        :shadow: md
        :icon: octicon-info

        Status returned by the optimization solver (e.g., "Optimal", "Feasible").

    .. grid-item-card:: solution_time
        :margin: 1
        :shadow: md
        :icon: octicon-clock

        Time (in seconds) taken to compute the schedule solution.

    .. grid-item-card:: num_fields
        :margin: 1
        :shadow: md
        :icon: octicon-number

        Number of scheduled pointings (i.e., observed fields), normalized by number of visits.

Next Steps
----------

Once the file `events.ecsv` is generated, it can be used for:

- Ranking event detectability
- Aggregated statistics over detection rates
- Comparison across multiple telescope configurations or campaigns

This forms the basis of many follow-up science analyses in gravitational wave and multi-messenger astronomy.
